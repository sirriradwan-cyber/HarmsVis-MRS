
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HarmsVis (MRS Edition) – by Mohamad Radwan Sirri</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
 body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0c10;color:#e5e7eb}
 .wrap{display:grid;grid-template-columns:520px 1fr;gap:12px;height:100vh}
 .pane{padding:14px;background:#16181d;overflow:auto}
 h1{margin:6px 0 10px;font-size:18px}
 .drop{border:2px dashed #475569;background:#0f1116;border-radius:10px;padding:12px;min-height:120px}
 .btn{background:#1f2937;color:#fff;border:none;border-radius:10px;padding:9px 12px;margin-right:6px;cursor:pointer}
 .btn.alt{background:#0f1116;border:1px solid #334155}
 .btn.danger{background:#7f1d1d}
 .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
 label{display:block;margin:8px 0 4px;color:#9ca3af;font-size:12px}
 input[type="text"],input[type="number"],textarea,select{width:100%;padding:8px;border:1px solid #2a2f3a;background:#0f1116;color:#e5e7eb;border-radius:8px}
 input[type="number"]{appearance:textfield}
 input[type="number"]::-webkit-outer-spin-button,
 input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0}
 textarea{min-height:120px;resize:vertical}
 table{width:100%;border-collapse:collapse}
 th,td{border-bottom:1px solid #2a2f3a;padding:6px;font-size:12px}
 #status{background:#0f1116;border:1px solid #2a2f3a;border-radius:8px;padding:8px;white-space:pre-wrap;font-size:12px;margin-top:8px;color:#cbd5e1}
 .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
 .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
 .hint{color:#94a3b8;font-size:12px}
 .switch{display:flex;align-items:center;gap:8px}
 .clickable{cursor:pointer}
 .zoombar{display:flex;align-items:center;gap:8px}
 .zoombar input[type=range]{width:220px}
 #holderWrap{transform-origin: top left; background:#0b0c10; padding:4px}
 .drag{cursor:grab; user-select:none}
 tr.dragging{opacity:0.5}
 tr.selected{background:#0f172a}
 .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
 .mini{font-size:12px;padding:6px 8px}
</style>
</head>
<body>
<div class="wrap">
 <div class="pane">
  <h1>HarmsVis (MRS Edition)</h1>
  <div style="margin-top:-6px;color:#9ca3af">by Mohamad Radwan Sirri</div>
  <div style="margin-top:2px;color:#a1a1aa;font-size:12px">Traffic lights &amp; summary bars for harms risk-of-bias</div>
  <div style="margin-top:6px;color:#a1a1aa;font-size:12px">
    <span style="padding:2px 6px;border:1px solid #2d2d2d;border-radius:999px">Version: v1.0.0</span>
    <span style="margin-left:8px">Docs/README: <a href="README.md" style="color:#93c5fd" target="_blank">open</a></span>
    <span style="margin-left:8px">DOI (placeholder): <a href="https://doi.org/10.xxxx/zenodo.xxxxxxx" style="color:#93c5fd" target="_blank">https://doi.org/10.xxxx/zenodo.xxxxxxx</a></span>
  </div>

  <div class="row">
    <button class="btn" id="btnTest">Test Render (sample)</button>
    <button class="btn alt" id="btnReset">Hard Reset</button>
  </div>

  <label>Option A — Paste from Excel (recommended)</label>
  <div id="paste" class="drop" contenteditable="true">Paste table here (Ctrl/Cmd + V)</div>

  <label>Option B — Paste plain text CSV/TSV</label>
  <textarea id="plain" placeholder="Study,Q1,Q2,...&#10;Study A,Yes,No,Unsure&#10;..."></textarea>
  <div class="row">
    <button class="btn alt" id="btnUsePlain">Load from Plain Text</button>
  </div>

  <div id="status">Status: app loaded. Waiting…</div>

  <label>Synonyms</label>
  <div class="row">
   <input id="low" type="text" value="yes, low, low risk, green, نعم, منخفض"/>
   <input id="mid" type="text" value="unsure, unclear, moderate, غير واضح, متوسط"/>
   <input id="high" type="text" value="no, high, high risk, لا, مرتفع"/>
  </div>

  <label>Legend (applies to Traffic & Summary)</label>
  <div class="three">
    <div><small>Show legend text</small>
      <select id="legendText">
        <option value="on" selected>On (Yes / Unsure / No)</option>
        <option value="off">Off (circles only)</option>
      </select>
    </div>
    <div><small>Legend gap</small><input id="legendGap" type="number" value="200" step="1"></div>
    <div><small>Labels</small><input id="legendLabels" type="text" value="Yes, Unsure, No"></div>
  </div>

  <label>Dimensions & Style (live apply)</label>
  <div class="two">
   <div><small>SVG width (px)</small><input id="svgW" type="number" value="1600" step="1"></div>
   <div><small>Export width (px)</small><input id="expW" type="number" value="6000" step="10"></div>
   <div><small>Row height</small><input id="rowH" type="number" value="28" step="1"></div>
   <div><small>Base circle size</small><input id="circle" type="number" value="16" step="1"></div>
   <div><small>Study column width</small><input id="studyW" type="number" value="300" step="1"></div>
   <div><small>Side padding</small><input id="pad" type="number" value="20" step="1"></div>
   <div><small>Header/Body font</small><input id="font" type="number" value="12" step="1"></div>
   <div><small>Footer font</small><input id="footerFont" type="number" value="11" step="1"></div>
  </div>

  <label>Zoom (preview only; export uses Export width)</label>
  <div class="zoombar">
    <button class="btn alt" id="zoomOut">–</button>
    <input type="range" id="zoomRange" min="50" max="300" value="100" step="5">
    <button class="btn alt" id="zoomIn">+</button>
    <span id="zoomLabel">100%</span>
  </div>

  <label>Question Columns</label>
  <div class="row">
    <label class="switch"><input type="checkbox" id="lockQWidth"> Lock question column width</label>
    <input id="qColW" type="number" value="90" step="1" title="Question column width (px)">
  </div>

  <label>Summary Bar Controls</label>
  <div class="two">
    <div><small>Summary bar width (px)</small><input id="sumBarW" type="number" value="800" step="1"></div>
    <div><small>Gap after label (px)</small><input id="labelGap" type="number" value="10" step="1"></div>
    <div><small>Show % ticks (0–100)</small>
      <select id="showTicks">
        <option value="row" selected>Per row</option>
        <option value="global">Global (one scale under all bars)</option>
        <option value="none">None</option>
      </select>
    </div>
    <div><small>Show segment % labels</small>
      <select id="showSegPct">
        <option value="on" selected>On</option>
        <option value="off">Off</option>
      </select>
    </div>
  </div>

  <div class="row">
    <label class="switch"><input type="checkbox" id="autoCircles" checked> Auto‑fit circles</label>
    <label class="switch"><input type="checkbox" id="autoNames" checked> Auto‑fit study names</label>
    <label class="switch"><input type="checkbox" id="live" checked> Live apply changes</label>
    <button class="btn alt" id="applyNow">Apply now</button>
  </div>

  <div class="row">
   <button class="btn" id="renderTraffic">Render Traffic</button>
   <button class="btn" id="renderSummary">Render Summary</button>
  </div>
  <div class="row">
   <button class="btn" id="pngT">Download Traffic PNG</button>
   <button class="btn" id="pngS">Download Summary PNG</button>
   <button class="btn" id="tiffT">Download Traffic TIFF</button>
   <button class="btn" id="tiffS">Download Summary TIFF</button>
  </div>

  <div class="row">
    <label class="switch"><input type="checkbox" id="showTrafficFooter" checked> Show footer questions under Traffic (included in export)</label>
  </div>

  <h3>Question Manager</h3>
  <div class="toolbar">
    <button class="btn mini" id="addQ">+ Add Q</button>
    <button class="btn danger mini" id="removeQ">− Remove Q (selected or last)</button>
    <button class="btn alt mini" id="renumberQ">Renumber Q → Q1..Qn</button>
  </div>
  <label>Q‑marker paste (optional):</label>
  <textarea id="qMarker" placeholder="Example:
Q1: Randomization process adequately described?
Q2 - Allocation concealment appropriate?
Q3) Blinding of outcome assessment?"></textarea>
  <div class="row">
    <button class="btn alt mini" id="parseQMarker">Parse and apply</button>
  </div>

  <div class="hint">Drag rows in the Questions table to re‑order. Double‑click any question to edit text. Use Q‑marker paste to auto‑fill by Q1/Q2/... patterns.</div>
 </div>

 <div class="pane">
   <div id="holderWrap"><div id="holder"></div></div>
   <h3>Studies</h3>
   <table id="studtab"><thead><tr><th>#</th><th>Study name</th></tr></thead><tbody></tbody></table>
   <h3>Questions</h3>
   <table id="qtab"><thead><tr><th>Q#</th><th>Text</th><th></th></tr></thead><tbody></tbody></table>
 </div>
</div>

<script>
const SAMPLE=`Study,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,Q9,Q10,Q11
Study A,Yes,Unsure,Yes,Yes,Unsure,Yes,Unsure,Yes,Yes,Unsure,Yes
Study B,Yes,Yes,Unsure,Yes,Yes,Yes,Unsure,Yes,Yes,Unsure,Yes
Study C,Yes,Yes,Yes,Unsure,Yes,Yes,Unsure,Yes,Yes,Unsure,Yes
Study D,Yes,Yes,Unsure,Yes,Yes,Yes,Unsure,Yes,Yes,Unsure,Yes`;

const state={
  mat:null,qids:[],qt:[],studies:[],
  low:new Set(), mid:new Set(), high:new Set(),
  W:1600,expW:6000,rowH:28,circ:16,font:12,footerFont:11,studyW:300,pad:20,
  autoCircles:true, autoNames:true, live:true,
  lockQWidth:false, qColW:90,
  legendText:'on', legendGap:200, legendLabels:["Yes","Unsure","No"],
  sumBarW:800, labelGap:10, showTicks:'row', showSegPct:'on',
  showTrafficFooter:true,
  lastRender:'both', zoom:1.0,
  selQIndex:-1
};
let measureCtx=null;
function getCtx(){ if(!measureCtx){ const c=document.createElement('canvas'); measureCtx=c.getContext('2d'); } return measureCtx; }
function textWidth(txt, px){ const ctx=getCtx(); ctx.font=`${px}px system-ui,Segoe UI,Roboto,Arial`; return Math.ceil(ctx.measureText(txt).width); }

function setStatus(t){document.getElementById('status').textContent=t;}
function parseHTMLTable(html){
  const doc=new DOMParser().parseFromString(html,'text/html');
  const tb=doc.querySelector('table'); if(!tb) return null;
  const out=[]; tb.querySelectorAll('tr').forEach(tr=>{
    const r=[]; tr.querySelectorAll('td,th').forEach(td=>r.push(td.textContent.trim()));
    if(r.some(x=>x!=="")) out.push(r);
  }); return out;
}
function parseCSV(text){
  const first=(text.split(/\\r?\\n/)[0]||""); const delim=(first.match(/\\t/g)||[]).length>(first.match(/,/g)||[]).length?"\\t":",";
  return text.trim().split(/\\r?\\n/).map(line=>line.split(delim).map(s=>s.trim())).filter(r=>r.some(x=>x!==""));
}
function ensureQuestionCount(n){
  const cur=state.qids.length;
  if(n<=cur) return;
  for(let i=cur;i<n;i++){
    state.qids.push("Q"+(i+1));
    state.qt.push("Q"+(i+1));
    if(state.mat){ state.mat.forEach(row=>row.push("")); }
  }
  rebuildQ();
}
function load(mat, tag=""){
  try{
    if(!mat||mat.length<2){setStatus("Table not detected. First column must be Study then Q1..QN.");return;}
    const head=mat[0].map(x=>x.toLowerCase());
    if(head[0]!=="study"){mat=[["Study",...mat[0].slice(1).map((_,i)=>"Q"+(i+1))],...mat];}
    const data=mat.slice(1);
    const nQ=data.reduce((m,r)=>Math.max(m, r.length-1),0);
    state.qids=Array.from({length:nQ},(_,i)=>"Q"+(i+1));
    state.qt=state.qids.slice();
    state.studies=data.map(r=>r[0]);
    state.mat=data.map(r=>{const rr=new Array(nQ+1).fill("");for(let i=0;i<Math.min(nQ+1,r.length);i++) rr[i]=r[i];return rr;});
    rebuildQ(); rebuildStudies();
    setStatus(`Loaded ${state.mat.length} studies × ${nQ} questions from ${tag||'data'}. Drag to reorder, add/remove with toolbar.`);
  }catch(e){ setStatus("Load error: "+e.message); }
}
function rebuildQ(){
  const tb=document.querySelector('#qtab tbody'); tb.innerHTML="";
  state.qids.forEach((q,i)=>{
    const tr=document.createElement('tr');
    tr.draggable=true; tr.dataset.idx=i;
    tr.innerHTML = `<td class="drag">≡ ${q}</td><td><input type="text" value="${(state.qt[i]||q).replace(/"/g,'&quot;')}"></td><td><button class="btn danger mini">Delete</button></td>`;
    tr.addEventListener('click',()=>{ state.selQIndex=i; updateQSelection(); });
    tr.addEventListener('dragstart',(e)=>{ tr.classList.add('dragging'); e.dataTransfer.setData('text/plain', String(i)); });
    tr.addEventListener('dragend',()=>{ tr.classList.remove('dragging'); });
    tr.addEventListener('dragover',(e)=>{ e.preventDefault(); });
    tr.addEventListener('drop',(e)=>{ e.preventDefault(); const from=parseInt(e.dataTransfer.getData('text/plain')); const to=i; reorderQ(from,to); });
    tr.querySelector('input').oninput=(e)=>{ state.qt[i]=e.target.value; reRenderIfLive(); };
    tr.querySelector('button').onclick=()=>{ removeQAt(i); };
    tb.appendChild(tr);
  });
}
function updateQSelection(){
  const rows=document.querySelectorAll('#qtab tbody tr');
  rows.forEach((r,idx)=>{ if(idx===state.selQIndex) r.classList.add('selected'); else r.classList.remove('selected'); });
}
function reorderQ(from,to){
  if(from===to) return;
  function moveInArray(arr){ const x=arr.splice(from,1)[0]; arr.splice(to,0,x); }
  moveInArray(state.qids); moveInArray(state.qt);
  if(state.mat){ state.mat.forEach(row=>{ const x=row.splice(from+1,1)[0]; row.splice(to+1,0,x); }); }
  state.qids=state.qids.map((_,i)=>"Q"+(i+1));
  rebuildQ(); reRenderIfLive();
}
function addQAt(pos,text){
  const n=state.qids.length;
  const p = (isFinite(pos) && pos>=1 && pos<=n+1) ? pos : n+1;
  const idx = p-1;
  state.qids.splice(idx,0,"Qtmp");
  state.qt.splice(idx,0,text||("Q"+p));
  if(state.mat){ state.mat.forEach(row=>row.splice(idx+1,0,"")); }
  state.qids = state.qids.map((_,i)=>"Q"+(i+1));
  rebuildQ(); reRenderIfLive();
}
function removeQAt(idx){
  const n=state.qids.length; if(n===0) return;
  const i= (idx>=0 && idx<n)? idx : n-1;
  state.qids.splice(i,1); state.qt.splice(i,1);
  if(state.mat){ state.mat.forEach(row=>row.splice(i+1,1)); }
  state.qids = state.qids.map((_,k)=>"Q"+(k+1));
  state.selQIndex = -1;
  rebuildQ(); reRenderIfLive();
}
function renumberQs(){
  state.qids = state.qids.map((_,i)=>"Q"+(i+1));
  rebuildQ(); reRenderIfLive();
}
function parseQMarker(){
  const raw=document.getElementById('qMarker').value;
  if(!raw.trim()){ setStatus('Q‑marker: nothing to parse.'); return; }
  const re = /(?:^|\n)\s*(?:Q|q)\s*(\d{1,3})\s*[:\-\.\)]\s*(.+?)(?=(?:\n\s*(?:Q|q)\s*\d{1,3}\s*[:\-\.\)])|\s*$)/gs;
  const found={}; let m; while((m=re.exec(raw))!==null){ const num=parseInt(m[1],10); const txt=m[2].trim(); if(!isNaN(num)&&txt){ found[num]=txt; } }
  const indices=Object.keys(found).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
  if(indices.length===0){ setStatus('Q‑marker: no Q1/Q2/... patterns found.'); return; }
  const maxN = Math.max(...indices);
  ensureQuestionCount(maxN);
  indices.forEach(k=>{ state.qt[k-1]=found[k]; });
  setStatus(`Q‑marker: applied ${indices.length} question(s), up to Q${maxN}.`);
  rebuildQ(); reRenderIfLive();
}

function rebuildStudies(){
  const tb=document.querySelector('#studtab tbody'); tb.innerHTML="";
  state.studies.forEach((s,i)=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=i+1; tr.appendChild(td1);
    const td2=document.createElement('td'); td2.textContent=s; td2.ondblclick=()=>{
      const old=td2.textContent;
      const inp=document.createElement('input'); inp.type='text'; inp.value=old;
      td2.textContent=''; td2.appendChild(inp); inp.focus();
      inp.onblur=()=>{ const val=inp.value; state.studies[i]=val; state.mat[i][0]=val; td2.textContent=val; reRenderIfLive(); };
      inp.onkeydown=(e)=>{ if(e.key==='Enter'){ inp.blur(); } };
    };
    tr.appendChild(td2); tb.appendChild(tr);
  });
}
function readParams(){
  state.W=parseInt(document.getElementById('svgW').value);
  state.expW=parseInt(document.getElementById('expW').value);
  state.rowH=parseInt(document.getElementById('rowH').value);
  state.circ=parseInt(document.getElementById('circle').value);
  state.font=parseInt(document.getElementById('font').value);
  state.footerFont=parseInt(document.getElementById('footerFont').value);
  state.studyW=parseInt(document.getElementById('studyW').value);
  state.pad=parseInt(document.getElementById('pad').value);
  state.autoCircles=document.getElementById('autoCircles').checked;
  state.autoNames=document.getElementById('autoNames').checked;
  state.live=document.getElementById('live').checked;
  state.low=new Set(document.getElementById('low').value.toLowerCase().split(',').map(s=>s.trim()).filter(Boolean));
  state.mid=new Set(document.getElementById('mid').value.toLowerCase().split(',').map(s=>s.trim()).filter(Boolean));
  state.high=new Set(document.getElementById('high').value.toLowerCase().split(',').map(s=>s.trim()).filter(Boolean));
  state.lockQWidth=document.getElementById('lockQWidth').checked;
  state.qColW=parseInt(document.getElementById('qColW').value);
  state.legendText=document.getElementById('legendText').value;
  state.legendGap=parseInt(document.getElementById('legendGap').value);
  state.legendLabels=document.getElementById('legendLabels').value.split(',').map(s=>s.trim());
  state.sumBarW=parseInt(document.getElementById('sumBarW').value);
  state.labelGap=parseInt(document.getElementById('labelGap').value);
  state.showTicks=document.getElementById('showTicks').value;
  state.showSegPct=document.getElementById('showSegPct').value;
  state.showTrafficFooter=document.getElementById('showTrafficFooter').checked;
}
function norm(v){v=(v||"").toString().trim().toLowerCase(); if(state.low.has(v)) return 'low'; if(state.high.has(v)) return 'high'; if(state.mid.has(v)) return 'mid'; return 'mid';}
function svgEl(n,attrs){const e=document.createElementNS('http://www.w3.org/2000/svg',n); for(const k in attrs) e.setAttribute(k,attrs[k]); return e;}
function toCanvas(svg, pxWidth){
  const xml=new XMLSerializer().serializeToString(svg);
  const img=new Image();
  const w=parseInt(svg.getAttribute('width'));
  const h=parseInt(svg.getAttribute('height'));
  const scale = (pxWidth && pxWidth>0)? (pxWidth / w) : 1;
  const c=document.createElement('canvas'); c.width=Math.round(w*scale); c.height=Math.round(h*scale);
  const ctx=c.getContext('2d');
  return new Promise(res=>{
    img.onload=()=>{
      ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,c.width,c.height);
      ctx.drawImage(img,0,0,c.width,c.height);
      res(c);
    };
    img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml);
  });
}
function canvasToTIFF_Raw(canvas, dpi=300){
  const w=canvas.width, h=canvas.height;
  const rgba=canvas.getContext('2d').getImageData(0,0,w,h).data;
  const rgb=new Uint8Array(w*h*3);
  for(let i=0,j=0;i<rgba.length;i+=4,j+=3){ rgb[j]=rgba[i]; rgb[j+1]=rgba[i+1]; rgb[j+2]=rgba[i+2]; }
  function u16(v){ const b=new Uint8Array(2); new DataView(b.buffer).setUint16(0,v,true); return b; }
  function u32(v){ const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,v,true); return b; }
  function concat(arrs){ let n=0; arrs.forEach(a=>n+=a.length); const out=new Uint8Array(n); let o=0; arrs.forEach(a=>{out.set(a,o);o+=a.length}); return out; }
  const header = concat([ new TextEncoder().encode("II"), u16(42), u32(8) ]);
  const entries=[]; function entry(tag,type,count,value){ const e=new Uint8Array(12); const dv=new DataView(e.buffer); dv.setUint16(0,tag,true); dv.setUint16(2,type,true); dv.setUint32(4,count,true); dv.setUint32(8,value,true); entries.push(e); }
  const IFDCount = 12; const ifdCountBytes = u16(IFDCount); const nextIFD = u32(0);
  const ifdStart = 8; const ifdBytesLen = 2 + 12*IFDCount + 4; const dataStart = ifdStart + ifdBytesLen; let cursor = dataStart;
  const bitsOffset = cursor; cursor += 6; const bitsData = new Uint8Array([8,0, 8,0, 8,0]);
  const xresOffset = cursor; cursor += 8; const yresOffset = cursor; cursor += 8;
  const xresData = concat([ u32(dpi), u32(1) ]); const yresData = concat([ u32(dpi), u32(1) ]);
  if(cursor % 2) cursor += 1; const imageDataOffset = cursor; cursor += rgb.length;
  entry(256,4,1,canvas.width); entry(257,4,1,canvas.height); entry(258,3,3,bitsOffset); entry(259,3,1,1);
  entry(262,3,1,2); entry(273,4,1,imageDataOffset); entry(277,3,1,3); entry(278,4,1,canvas.height);
  entry(279,4,1,rgb.length); entry(282,5,1,xresOffset); entry(283,5,1,yresOffset); entry(296,3,1,2);
  const ifdBlock = concat([ ifdCountBytes, ...entries, nextIFD ]);
  const dataBlobs = new Uint8Array(imageDataOffset - dataStart); dataBlobs.set(bitsData, bitsOffset - dataStart);
  dataBlobs.set(xresData, xresOffset - dataStart); dataBlobs.set(yresData, yresOffset - dataStart);
  const final = concat([ header, ifdBlock, dataBlobs, rgb ]);
  return new Blob([final], {type:"image/tiff"});
}

function legendGroup(x,y,font){
  const g=svgEl('g',{});
  const items=[
    {col:'#22c55e', label:state.legendLabels[0]||'Yes'},
    {col:'#facc15', label:state.legendLabels[1]||'Unsure'},
    {col:'#ef4444', label:state.legendLabels[2]||'No'}
  ];
  items.forEach((it,i)=>{
    const dx=i*state.legendGap;
    const r=svgEl('circle',{cx:x+dx, cy:y, r:6, fill:it.col, stroke:'#111827','stroke-width':'0.5'});
    g.appendChild(r);
    if(state.legendText==='on'){
      const t=svgEl('text',{x:x+dx+12,y:y+4,fill:'#111827','font-size':font}); t.textContent=it.label;
      g.appendChild(t);
    }
  });
  return g;
}

function autoFontForName(name, basePx, maxWidth){
  if(!state.autoNames) return basePx;
  const c = Math.max(1, textWidth(name, basePx));
  if(c<=maxWidth) return basePx;
  const px=Math.max(8, Math.floor(basePx*(maxWidth/c)));
  return px;
}
function circleRadius(colW){
  if(!state.autoCircles) return Math.max(2, state.circ/2);
  const r = Math.min(state.rowH*0.45, colW*0.45, state.circ/2);
  return Math.max(2, r);
}
function measureFooter(lines,font){ return 20 + lines * Math.max(14, font + 4); }

function renderTraffic(){
  try{
    readParams(); if(!state.mat){alert('Paste data first (or press Test Render).');return;}
    const pad=state.pad, RH=state.rowH, rows=state.mat.length+1, studyW=state.studyW;
    const cols = state.qids.length + 1;
    let colW;
    if(state.lockQWidth){
      colW = state.qColW;
      state.W = pad*2 + studyW + colW * (cols-1);
      document.getElementById('svgW').value = state.W;
    }else{
      colW = (state.W - studyW - pad*2)/(cols-1);
    }
    const rad=circleRadius(colW);
    const legendH = 28;
    const footerH = state.showTrafficFooter ? measureFooter(state.qids.length, state.footerFont) : 0;
    const H=pad*2+rows*RH + legendH + 8 + footerH + 16;
    const W=state.W;

    const svg=svgEl('svg',{width:W,height:H,viewBox:`0 0 ${W} ${H}`,id:'trafficSVG'});
    svg.appendChild(svgEl('rect',{x:0,y:0,width:W,height:H,fill:'#ffffff'}));
    const g=svgEl('g',{}); svg.appendChild(g);
    g.appendChild(svgEl('rect',{x:pad,y:pad,width:W-pad*2,height:RH,fill:'#f3f4f6'}));
    for(let r=0;r<=rows;r++) g.appendChild(svgEl('line',{x1:pad,y1:pad+r*RH,x2:W-pad,y2:pad+r*RH,stroke:'#d1d5db'}));
    for(let c=0;c<=cols;c++){ const x=pad+(c===0?0:studyW+(c-1)*colW); g.appendChild(svgEl('line',{x1:x,y1:pad,x2:x,y2:pad+rows*RH,stroke:'#d1d5db'})); }
    const headFont=state.font;
    const head=svgEl('text',{x:pad+8,y:pad+RH-8,fill:'#111827','font-size':headFont,'font-weight':'700'}); head.textContent='Study'; g.appendChild(head);
    state.qids.forEach((q,i)=>{ const t=svgEl('text',{x:pad+studyW+i*colW+colW/2,y:pad+RH-8,fill:'#111827','font-size':headFont,'text-anchor':'middle','font-weight':'700'}); t.textContent=q; g.appendChild(t); });
    state.mat.forEach((r,i)=>{
      const y=pad+(i+1)*RH+RH/2;
      const name=r[0]||"";
      const maxNameW = studyW - 16;
      const namePx=autoFontForName(name, headFont, maxNameW);
      const t=svgEl('text',{x:pad+8,y:y+4,fill:'#111827','font-size':namePx}); t.textContent=name; g.appendChild(t);
      for(let j=0;j<state.qids.length;j++){
        const val=(r[j+1]||""); if(!val) continue;
        const cat=norm(val); const col=cat==='low'?'#22c55e':cat==='high'?'#ef4444':'#facc15';
        g.appendChild(svgEl('circle',{cx:pad+studyW+j*colW+colW/2,cy:y,r:rad,fill:col,stroke:'#111827','stroke-width':'0.5'}));
      }
    });
    const legY = pad + rows*RH + 16;
    g.appendChild(legendGroup(pad+8, legY, state.font));

    if(state.showTrafficFooter){
      const titleY=legY + 20;
      g.appendChild(svgEl('text',{x:pad,y:titleY,fill:'#111827','font-size':headFont,'font-weight':'700'})).textContent='Questions:';
      const f=state.footerFont; let yy=titleY+16; state.qids.forEach((q,i)=>{
        const t=svgEl('text',{x:pad,y:yy+i*(f+6),fill:'#111827','font-size':f}); t.textContent=`${q}: ${state.qt[i]||state.qids[i]}`; g.appendChild(t);
      });
    }

    const holder=document.getElementById('holder'); const old=document.getElementById('trafficSVG'); if(old) old.remove();
    holder.prepend(svg);
    setStatus(`Rendered Traffic ✓`);
    state.lastRender='traffic';
    applyZoomDisplay();
  }catch(e){ setStatus('Traffic error: '+e.message); }
}

function renderSummary(){
  try{
    readParams(); if(!state.mat){alert('Paste data first (or press Test Render).');return;}
    const pad=state.pad, RH=state.rowH, tickFont=10;
    const counts=state.qids.map(()=>({l:0,m:0,h:0,t:0}));
    state.mat.forEach(r=>{ for(let j=0;j<state.qids.length;j++){ const v=(r[j+1]||""); if(!v) continue; const c=norm(v); if(c==='low') counts[j].l++; else if(c==='high') counts[j].h++; else counts[j].m++; counts[j].t++; }});

    const labels = state.qids.map((q,i)=>`${q}: ${state.qt[i]||state.qids[i]}`);
    const labelW = Math.max(...labels.map(t=>textWidth(t, state.font))) + state.labelGap;
    const barW = state.sumBarW;
    const pctArea  = (state.showSegPct==='on') ? 16 : 0;
    const tickAreaPerRow = (state.showTicks==='row') ? 24 : 0;
    const rowTotal = RH + pctArea + tickAreaPerRow + 8;
    const rows = counts.length;

    const legendH = 28;
    const tickGlobalH = (state.showTicks==='global') ? 26 : 0;
    const W = Math.max(state.W, pad*2 + labelW + barW);
    const H = pad*2 + rows*rowTotal + tickGlobalH + legendH + 40;

    const svg=svgEl('svg',{width:W,height:H,viewBox:`0 0 ${W} ${H}`,id:'summarySVG'});
    svg.appendChild(svgEl('rect',{x:0,y:0,width:W,height:H,fill:'#ffffff'}));
    const g=svgEl('g',{}); svg.appendChild(g);

    const x0 = pad + labelW;
    for(let i=0;i<rows;i++){
      const yTop = pad + i*rowTotal;
      const label=labels[i];
      const t=svgEl('text',{x:pad+4,y:yTop+RH*0.7,fill:'#111827','font-size':state.font,'class':'clickable'});
      t.textContent=label;
      t.addEventListener('dblclick',()=>{
        const current = state.qt[i] || state.qids[i];
        const nv = prompt(`Edit question text for ${state.qids[i]}`, current);
        if(nv!==null){ state.qt[i] = nv; reRenderIfLive(); }
      });
      g.appendChild(t);

      const gy=yTop+RH*0.2; const bh=RH*0.6;
      g.appendChild(svgEl('rect',{x:x0,y:gy,width:barW,height:bh,fill:'#e5e7eb',rx:bh*0.3}));
      const c=counts[i]; const T=Math.max(1,c.t);
      const wL=barW*(c.l/T), wM=barW*(c.m/T), wH=barW*(c.h/T);
      let x=x0;
      if(wL>0){g.appendChild(svgEl('rect',{x:x,y:gy,width:wL,height:bh,fill:'#22c55e'})); x+=wL;}
      if(wM>0){g.appendChild(svgEl('rect',{x:x,y:gy,width:wM,height:bh,fill:'#facc15'})); x+=wM;}
      if(wH>0){g.appendChild(svgEl('rect',{x:x,y:gy,width:wH,height:bh,fill:'#ef4444'}));}

      if(state.showTicks==='row'){
        const yTicks = gy + bh + 10;
        g.appendChild(svgEl('line',{x1:x0,y1:yTicks,x2:x0+barW,y2:yTicks,stroke:'#94a3b8','stroke-width':'0.5'}));
        for(let p=0;p<=100;p+=10){
          const xx = x0 + (p/100)*barW;
          g.appendChild(svgEl('line',{x1:xx,y1:yTicks-4,x2:xx,y2:yTicks+4,stroke:'#94a3b8','stroke-width':'0.5'}));
          const tickText=svgEl('text',{x:xx,y:yTicks+12,fill:'#6b7280','font-size':10,'text-anchor':'middle'}); tickText.textContent=p; g.appendChild(tickText);
        }
      }
      if(state.showSegPct==='on'){
        const yPct = gy + bh + 10 + (state.showTicks==='row'? 22 : 0);
        const lPct = Math.round((c.l/T)*100);
        const mPct = Math.round((c.m/T)*100);
        const hPct = Math.round((c.h/T)*100);
        const pctText=svgEl('text',{x:x0,y:yPct,fill:'#111827','font-size':10});
        pctText.textContent = `Low: ${lPct}%   Unsure: ${mPct}%   High: ${hPct}%`;
        g.appendChild(pctText);
      }
    }

    if(state.showTicks==='global'){
      const yTicks = pad + rows*rowTotal + 10;
      g.appendChild(svgEl('line',{x1:x0,y1:yTicks,x2:x0+barW,y2:yTicks,stroke:'#94a3b8','stroke-width':'0.5'}));
      for(let p=0;p<=100;p+=10){
        const xx = x0 + (p/100)*barW;
        g.appendChild(svgEl('line',{x1:xx,y1:yTicks-4,x2:xx,y2:yTicks+4,stroke:'#94a3b8','stroke-width':'0.5'}));
        const tickText=svgEl('text',{x:xx,y:yTicks+12,fill:'#6b7280','font-size':10,'text-anchor':'middle'}); tickText.textContent=p; g.appendChild(tickText);
      }
    }

    const afterRowsY = pad + rows*rowTotal + (state.showTicks==='global'?26:0) + 16;
    g.appendChild(legendGroup(pad+4, afterRowsY, state.font));

    const holder=document.getElementById('holder'); const old=document.getElementById('summarySVG'); if(old) old.remove();
    holder.appendChild(svg);
    setStatus('Rendered Summary ✓');
    state.lastRender='summary';
    applyZoomDisplay();
  }catch(e){ setStatus('Summary error: '+e.message); }
}

async function savePNG(id,name){ const s=document.getElementById(id); if(!s){alert('Render first');return;} const c=await toCanvas(s,state.expW); c.toBlob(b=>{const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(u),500);}); }
async function saveTIFF(id,name){ const s=document.getElementById(id); if(!s){alert('Render first');return;} const c=await toCanvas(s,state.expW); const tiff=canvasToTIFF_Raw(c,300); const u=URL.createObjectURL(tiff); const a=document.createElement('a'); a.href=u; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(u),500); }

function applyZoomDisplay(){
  const wrap=document.getElementById('holderWrap');
  wrap.style.transform = `scale(${state.zoom})`;
  document.getElementById('zoomLabel').textContent = Math.round(state.zoom*100)+'%';
  document.getElementById('zoomRange').value = Math.round(state.zoom*100);
}
function reRenderIfLive(){ if(!document.getElementById('live').checked) return;
  if(document.getElementById('trafficSVG')) renderTraffic();
  if(document.getElementById('summarySVG')) renderSummary();
  if(!document.getElementById('trafficSVG') && !document.getElementById('summarySVG')){
    if(state.lastRender==='traffic') renderTraffic(); else if(state.lastRender==='summary') renderSummary();
  }
}
function readInitial(){ readParams(); applyZoomDisplay(); }

// Events
document.getElementById('renderTraffic').onclick=()=>{ state.lastRender='traffic'; renderTraffic(); };
document.getElementById('renderSummary').onclick=()=>{ state.lastRender='summary'; renderSummary(); };
document.getElementById('pngT').onclick=()=>savePNG('trafficSVG','HarmsVis_traffic.png');
document.getElementById('pngS').onclick=()=>savePNG('summarySVG','HarmsVis_summary.png');
document.getElementById('tiffT').onclick=()=>saveTIFF('trafficSVG','HarmsVis_traffic.tiff');
document.getElementById('tiffS').onclick=()=>saveTIFF('summarySVG','HarmsVis_summary.tiff');

document.getElementById('btnTest').onclick=()=>{ load(parseCSV(SAMPLE),'sample'); renderTraffic(); renderSummary(); };
document.getElementById('btnReset').onclick=()=>{ location.reload(); };
document.getElementById('btnUsePlain').onclick=()=>{ const text=document.getElementById('plain').value; if(!text.trim()){ setStatus('Plain text is empty.'); return; } load(parseCSV(text),'plain'); };

['svgW','expW','rowH','circle','font','footerFont','studyW','pad','qColW','legendText','legendGap','legendLabels','low','mid','high','sumBarW','labelGap','showTicks','showSegPct','showTrafficFooter'].forEach(id=>{
  document.getElementById(id).addEventListener('input', reRenderIfLive);
});
['autoCircles','autoNames','live','lockQWidth'].forEach(id=>document.getElementById(id).addEventListener('change', reRenderIfLive));
document.getElementById('applyNow').onclick=reRenderIfLive;

// Zoom controls
const zr=document.getElementById('zoomRange');
zr.addEventListener('input',()=>{ state.zoom = parseInt(zr.value)/100; applyZoomDisplay(); });
document.getElementById('zoomIn').onclick=()=>{ state.zoom = Math.min(3, (state.zoom*100+10)/100); applyZoomDisplay(); };
document.getElementById('zoomOut').onclick=()=>{ state.zoom = Math.max(0.5, (state.zoom*100-10)/100); applyZoomDisplay(); };

// Q manager events
document.getElementById('addQ').onclick=()=>{
  const pos = prompt("Insert position (1..N+1). Leave blank to append:");
  const text = prompt("Question text (required):","");
  if(text!==null && text.trim()!==""){ addQAt(parseInt(pos,10), text.trim()); }
};
document.getElementById('removeQ').onclick=()=>{
  const idx = state.selQIndex>=0? state.selQIndex : -1;
  removeQAt(idx);
};
document.getElementById('renumberQ').onclick=renumberQs;
document.getElementById('parseQMarker').onclick=parseQMarker;

document.getElementById('paste').addEventListener('paste',(ev)=>{
  const html=(ev.clipboardData||window.clipboardData).getData('text/html');
  const text=(ev.clipboardData||window.clipboardData).getData('text/plain');
  let mat=null; if(html) mat=parseHTMLTable(html); if(!mat && text) mat=parseCSV(text);
  if(mat){ ev.preventDefault(); load(mat,'clipboard'); } else setStatus("Paste failed: paste CSV or a real HTML table.");
});

window.addEventListener('load',()=>{ load(parseCSV(SAMPLE),'auto-sample'); readInitial(); renderTraffic(); renderSummary(); });
</script>
</body>
</html>
